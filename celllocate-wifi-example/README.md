# XPLR-IOT-1-location-example

This example is intended to be used with XPLR-IOT-1 from u-blox to get a location using both Cell ID and Wi-Fi sniffing technology using the u-blox CellLocate service. The example contains the location example for XPLR-IOT-1 and future updates of this application will be uploaded here. It is assumed that XPLR-IOT-1 has a Serial Bootloader that allows firmware on the device to be updated without the need of a debugger/programmer.

The main function of the example is to collect Cellular or Wi-Fi information and send it to CellLocate service to get back a location in response. The Wi-Fi module can be enabled/disabled in the configuration parameters in the code for the location calculation. The example uses ubxlib library as much as possible to implement the functionality, and was tested and compiled with nRF Connect v1.7.0. 

The example is compatible with:
- NINA firmware version 5.0.0. 
- SARA-R510S-01B release 03.15_ENG1301. Please contact support@thingstream.io to get the firmware.
- Firmware upgrade procedure is available in this guide: https://www.u-blox.com/docs/UBX-21035674

To check the already installed firmware version on your module, use the following command: 
- AT+CGMR

**Note:** 
 For SARA-R5, if the command returns the firmware version like "3.15, A00.01", please be informed that the installed firmware is different from the required firmware version i.e. 03.15_ENG1301.  

Prerequisite and notes:
- To access to CellLocate service you need a valid token, that is the alphanumeric string generated by u-blox Thingstream service delivery platform; it is used by the device for service authentication. This guide explains how to generate it
https://developer.thingstream.io/guides/location-services/tokens
- CellLocate service provide by default the estimated location back the XPLR-IOT kit; in addition you can get the estimated position directly to your cloud application using a Cloud to Cloud connection;
https://developer.thingstream.io/guides/location-services/celllocate-getting-started/location-in-the-cloud


## Firmware Update

1. Clone the XPLR-IOT-1-location-example.

2. Go to location *XPLR1-IOT-location-example/image_flashing*. The folder with contain a pre-build binary named **celllocate-wifi-example.bin** which can be directly flashed to the device. 

3. If some tweaks are done in the firmware, build the code again. Instructions for building firmware can be found here: https://github.com/u-blox/XPLR-IOT-1-software#building--the-firmware.  

4. Building the code will generate a binary file named as **app_update.bin** at the following location:
*XPLR1-IOT-location-example/celllocate-wifi-example/build/zephyr*

5. Copy the file **app_update.bin** to the given location: 
*XPLR1-IOT-location-example/image_flashing*

6. Go to *XPLR1-IOT-location-example/image_flashing* folder. 

7. Connect your XPLR-IOT-1 kit to your system and determine the COM port number for NORA-B1 on Interface 0 of the USB-UART interface. 

8. Power cycle your XPLR-IOT-1 device while holding button 1 to enter the bootloader mode.

9. Run *Update_XPLR-IOT-1-Location.bat* file and a pop-up window will appear input your comport as following:

![Bat file pop-up](../imgs/bat.PNG?raw=true)

10. Input your comport, your binary file name and press enter. The process will start flashing your image file into your kit.

11. More details about the XPLR-IOT-1 bootloader can be found in the following link: [XPLR-IOT-1](https://github.com/u-blox/XPLR-IOT-1-software/tree/main/tools_and_compiled_images)


## Configuration for Cellular and Wi-Fi
To get the location from the XPLR-IOT-1 kit using Cellular or Wi-Fi, the device is needed to be configured accordingly. To configure the device, the steps are given as following

1. Connect the device to the system using COM port for NORA-B1 on Interface 0 of the USB-UART interface.

2. To configure the device, "config set" command is used. The configuration has to be set everytime the device is turned on. The command format is as following:

    **config set 'CellLocateServerURL' 'Token' 'APN' 'CellRegistrationTimeout' 'NumWifiAp' 'WifiApSignalStrength'**

    A sample command and the response for config set is given below:
    ```sh
    $ config set cell-live1.services.u-blox.com 9ARdeV0FSDKpKfSE7GpeSQ tsiot 30 10 -90
    > CellLocateServerURL: cell-live1.services.u-blox.com, Token: 9ARXeV0FSDKpKfKE7ZpeSQ, APN: tsiot, CellRegistrationTimeout: 30, NumWifiAp: 10, WifiApSignalStrength: -90
    ```

3. To view the configuration set on the device, "config get" command is used.
The command and the response for config get is given below:
    ```sh
    $ config get
    > CellLocateServerURL: cell-live1.services.u-blox.com, Token: 9ARXeV0FSDKpKfKE7ZpeSQ, APN: tsiot, CellRegistrationTimeout: 30, NumWifiAp: 10, WifiApSignalStrength: -90
    ```

4. To get help with device configurations for using Cellular or Wi-Fi "config help" command is used.
The command and the response for config help is given below: 
    ```sh
    $ config help
    > config - Configuration of parameters
    > Subcommands:
    >  get  :read configuration parameters
    >  set  :set configuration parameters: <CellLocateServerURL> <Token> <APN>
    >        <CellRegistrationTimeout(s)> <NumWifiAp> <WifiApSignalStrength(dbm)>
    ```

## Location using CellLocate Service
To get the location from the XPLR-IOT-1 kit using Cellular or Wi-Fi, a valid configuration setting is required as a pre-requisite for this command.

1. The command to get location using cellular network is given below:
    ```sh
    $ location cell
    ```

2. The command to get location using Wi-Fi access points is given below:
    ```sh
    $ location wifi
    ```


## Description

The user is required to set some configurable parameters using *config set* command as per the user's requirements and the example will bring back the location based on those parameters. The configurable parameters are explained below: 

1. **CellLocateServerURL**
The URL of the CellLocate server which the service pings to get the location. The maximum length of the URL is 100 bytes. 


2. **Token**:
The user needs to enter the CellLocate service token against which the device is registered on Thingstream. The maximum allowed length of token is 25 bytes. 

3. **APN**:
The user needs to set the APN name for the network being used to run the example. The maximum allowed length is 50bytes. 

4. **CellRegistrationTimeout**:
The time for which the device waits to establish a successful connection with the network. The range of allowed timeout is 1sec to 300sec.  

5. **NumWifiAp**: 
The user needs to set the no. of Wi-Fi access points as per the requirements. The allowed range for APs is between 5 to 15. 

6. **WifiApSignalStrength**
The user needs to set the signal strength for Wi-Fi scan in dBm with 0 dBm being the maximum signal strength and -100 dBm being the minimum.
A list of Wi-Fi signal strength is given below for reference:  

* -30 dBm	: Maximum signal strength.
* -50 dBm	: Excellent signal strength.
* -60 dBm	: Still good, reliable signal strength.
* -67 dBm	: Minimum value for all services that require smooth and reliable data traffic.
* -70 dBm	: Signal is not very strong
* -80 dBm	: Minimum value required to make a connection.
* -90 dBm	: Unlikely able to connect or make use of any services 



Once the configurations are done, use *config get* command to verify your configurations. For further information of firmware flash, refer to [XPLR-IOT-1](https://github.com/u-blox/XPLR-IOT-1) and [XPLR-IOT-1-software](https://github.com/u-blox/XPLR-IOT-1-software#programmingbuilding-the-firmware)   


## Note

After the firmware upgrade on SARA R5, the module stops responding to NORA-B1 Comport. To enable the communication, the user needs to send the following AT commands to NORA: 

  - AT+USIO=2
  - AT+CFUN=16

In case you are not getting the position information or you are getting unexpected results, it's suggested to look at the following guides:
- [Module connection setup](https://developer.thingstream.io/guides/location-services/celllocate-getting-started/module-connection-setup) to verify that the cellular connection have been properly estabilished and that the module can access to Internet and reach the CellLocate server
- [Troubleshooying guide](https://developer.thingstream.io/guides/location-services/celllocate-getting-started/celllocate-troubleshooting-guide) to verify if you are in any of the listed edge cases



## Disclaimer
Copyright © u-blox

u-blox reserves all rights in this deliverable (documentation, software, etc., hereafter “Deliverable”).

u-blox grants you the right to use, copy, modify and distribute the Deliverable provided hereunder for any purpose without fee.

THIS DELIVERABLE IS BEING PROVIDED "AS IS", WITHOUT ANY EXPRESS OR IMPLIED WARRANTY. IN PARTICULAR, NEITHER THE AUTHOR NOR U-BLOX MAKES ANY REPRESENTATION OR WARRANTY OF ANY KIND CONCERNING THE MERCHANTABILITY OF THIS DELIVERABLE OR ITS FITNESS FOR ANY PARTICULAR PURPOSE.

In case you provide us a feedback or make a contribution in the form of a further development of the Deliverable (“Contribution”), u-blox will have the same rights as granted to you, namely to use, copy, modify and distribute the Contribution provided to us for any purpose without fee.
