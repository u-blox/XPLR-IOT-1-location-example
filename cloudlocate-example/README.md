# XPLR-IOT-1-cloudlocate-example

CloudLocate enables positioning in the cloud to extend the life of energy-constrained IoT applications, with up to 10X energy savings over a standalone GNSS approach. The service uses IoT device measurements to calculate a location and deliver it to the enterprise. CloudLocate is ideally suited for IoT asset tracking applications that require large power autonomy, a few position updates per day, reasonable position accuracy, and for which location is needed in the cloud as opposed to on the device itself. 

This example is intended to be used with XPLR-IOT-1 from u-blox to get a location using CloudLocate technology. It uses M10 GNSS receiver (FW SPG 5.10) in the  XPLR-IOT-1 kit to get the location.  

The main function of the example is to collect the raw measurement generated by GNSS in the format of u-blox message (UBXM-RXM-MEASX/MEAS50/MEAS20) and send it to CloudLocate service that estimates the position in the cloud. For communication with the cloud, the example uses SARA-R5 MQTT client. 

The example uses ubxlib to implement most of its functionalities and it is recommended not to change the location of ubxlib directory else the paths in project will have to be changed accordingly.

Any future updates of this application will be uploaded here.

## Prerequisite

To access to CloudLocate service you need to create a CloudLocate Thing that is the logical representation of the device in the u-blox Thingstream service delivery platform; the Cloudocate Thing provides the MQTT credentials and MQTT topics to be used by the device for service authentication and communication with the cloud over MQTT protocol. For step by step process, refer to **Configure the Thingstream platform** section of the guide given below:
https://developer.thingstream.io/guides/location-services/cloudlocate-getting-started/

The main steps to use the service are:
1. Setup the CloudLocate Thing, get the credentials and MQTT topics
2. Configure the MQTT client in the device with the above settings (in this example it is used the client of the SARA-R5 Cellular modem)
3. Generate the raw measurement from GNSS
4. Publish the raw measurement in the MQTT topic and get the estimated postion in the response MQTT topic


## Setup

1. Set your CloudLocate location thing credentials and APN in the code, save it and build. You can also tweek the configuration parameters in the code. For the details, see [Description](#description).   

2. Building the code will generate a binary file named as **app_update.bin** at the following location:

*XPLR1-IOT-location-example/cloudlocate-example/build/zephyr*

3. Copy the **app_update.bin** file and paste it at the given location: 

*XPLR1-IOT-location-example/image_flashing*

4. Go to *XPLR1-IOT-location-example/image_flashing* folder. 

5. Connect your XPLR-IOT-1 kit to your system and determine the COM port number for NORA-B1 on Interface 0 of the USB-UART interface. 

6. Run *Update_XPLR-IOT-1-Location.bat* file and a pop-up window will appear input your comport as following: 

![Bat file pop-up](../imgs/bat.PNG?raw=true)

## Description

This example provides backs to the device (XPLR-IOT-KIT-1) the location estimated in the cloud using the raw measurements generated by MAX-M10 GNSS. M10 module is a GNSS receiver capable to generate multiple types of  raw measurements based on the configurable parameters provided by the user.
These raw measurements can either be compact messages like:
- UBX-RXM-MEAS20 (20 bytes)
- UBX-RXM-MEAS50 (50 bytes)

or UBX-RXM-MEASX message (>170 bytes) based on user's requirements. 
To send these messages to the CloudLocate service, MQTT protocol is used. 

For MQTT based communication with the cloud, the example uses SARA-R5 MQTT client. The MQTT request and response topics for a location thing can be obtained from Thingstream portal. 

The user is required to set some configurable parameters as per the requirements and the example will bring back the location based on those parameters. The configurable parameters are: 

1. **MSG_TYPE**:
The user needs to set the message type for which the raw measurements are required.  

`const messageType_t MSG_TYPE = <your_desired_message_type>;`

A list of message types accepted by the code are given below:  

* MEASX
* MEAS50
* MEAS20
* NAVPVT

2. **NUM_OF_SECONDS_TO_WAIT_FOR_FIRST_MESSAGE**: 
It is the minimum waiting time (in seconds) before getting the first measurement from the GNSS receiver. The GNSS automatically sends in output the selected message once the internal criterias are met.  If this timer value is set to 0, this very first valid message will be picked, otherways the sample code waits more seconds until the NUM_OF_SECONDS_TO_WAIT_FOR_FIRST_MESSAGE is expired. Usually the first valid message is sent out by the GNSS approximately after 3-4 seconds, but you might want to set the timer to 8 seconds, for example, to get more stable GNSS signals    

`const int32_t NUM_OF_SECONDS_TO_WAIT_FOR_FIRST_MESSAGE = <your_wait_time_sec>`

3. **COMPACT_MSG_TIMEOUT_IN_SECS**:
It is the maximum waiting time to get a valid message from the receiver. If the receiver fails to provide a valid message in the given timeout, the measurement is aborted (if fallback is disabled). The default value is set to 20 sec. This timer shall be grater than the previous one.

`const int32_t COMPACT_MSG_TIMEOUT_IN_SECS = <your_timeout_sec>`

4. **FALLBACK_NAVPVT_ENABLED**:
This is a flag to enable a fallback option. In case the receiver fails to provide a valid compact message within the given timeout, a UBX-NAV-PVT message is used to get a location based on it. The UBX-NAV-PVT contains the position estimated locally by the GNSS receiver. To enable NAVPVT message, the flag must be set to true.  

`bool FALLBACK_NAVPVT_ENABLED = <true/false>;`

5. **FALLBACK_TIMEOUT_IN_SECS**
It is the maximum waiting time to get a measurement based on UBX-NAV-PVT message. If it times out, the fallback will be aborted. 

`const int32_t FALLBACK_TIMEOUT_IN_SECS = <your_fallback_timeout>;`

6. **APN**:
This field refers to *Access Point Name* and must be filled with the APN of the network service provided whose SIM card is being used in the device.

`#define APN "<your_APN>"`

7. **CLIENT_ID**
It is the device ID of the CludLocate Thing created on the Thingstream portal. This field is required to subscribe to the unique MQTT topic for your device. 

`#define CLIENT_ID "<your_device_ID>"`

8. **USERNAME**
It is the username of the CludLocate Thing created on the Thingstream portal and is required for the service authentication.

`#define USERNAME "<your_device_username>"`

9. **PASSWORD**
It is the password of the CludLocate Thing created on the Thingstream portal and is required for the service authentication.

`#define PASSWORD "<your_device_password>"`

10. **SUB_TOPIC**
This is MQTT topic on which device has to subscribe to receive the response and location from the cloud. The format of the topic is given below: 

`#define SUB_TOPIC "CloudLocate/{your_deviceID}/GNSS/response"`


There are some use cases in which the device does not have connectivity all the time. Even in this case you can use CloudLocate service by storing the time and date of the snapshot and send it in the following format:

`{`
`"body":"Base64 encoded measurement (String)",`
`"headers":{"UTCDateTime":"yyyy-mm-ddThh:mm:ss"}`
`}`

Note: The current example does not support delayed message. The code needs to be updated in order to cater this scenario. For more information regarding CloudLocate service, refer to [CloudLocate getting started](https://developer.thingstream.io/guides/location-services/cloudlocate-getting-started) 

The user can also get the position in the cloud. For details, refer to next section.  

## Get the location on your cloud application 

The main advantage of CloudLocate is that the GNSS remains switched on for few seconds to generate the raw measurement thus reducing significanty the consumed energy. The assumption is that the location inforation (estimated position) is not required in the device but on the cloud application that collects the estimated position of all the devices.

To get the location from your cloud application you need:

1. Create an IP Thing in the Thingstream platform. This logical object  provides you the MQTT credential to access to the platform with MQTT protocol from the MQTT client in your cloud application. Through this Thing you can get the location of all your devices

* Select the Things item on the left sidebar 

* Click on "Add Thing" and then on "Add new IP Thing"; give it a name

* Select a plan. For test purpose you can select the developer plan

2. configure an MQTT client in your cloud application with the credentials and the endpoint provided in the related section of the new IP Thing

3. Subscribe from the MQTT client in your cloud application to CloudLocate/+/GNSS/response topic to get the position of all the devices using CloudLocate. If you want the position of a single device you can replace the +  with the device ID device:xyzwe-9999-1234-5678-9abcdefg

Note: you can decide to get the estimated position on both side (cloud and device) or only on one side  by simply subscribing to the right topic. When getting the position on the device you cannot use the wildcard  + but only the topic that include the device ID in the path


## Disclaimer
Copyright © u-blox

u-blox reserves all rights in this deliverable (documentation, software, etc., hereafter “Deliverable”).

u-blox grants you the right to use, copy, modify and distribute the Deliverable provided hereunder for any purpose without fee.

THIS DELIVERABLE IS BEING PROVIDED "AS IS", WITHOUT ANY EXPRESS OR IMPLIED WARRANTY. IN PARTICULAR, NEITHER THE AUTHOR NOR U-BLOX MAKES ANY REPRESENTATION OR WARRANTY OF ANY KIND CONCERNING THE MERCHANTABILITY OF THIS DELIVERABLE OR ITS FITNESS FOR ANY PARTICULAR PURPOSE.

In case you provide us a feedback or make a contribution in the form of a further development of the Deliverable (“Contribution”), u-blox will have the same rights as granted to you, namely to use, copy, modify and distribute the Contribution provided to us for any purpose without fee.
